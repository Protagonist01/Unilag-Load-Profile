<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNILAG Load Profile & Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .gemini-output {
            white-space: pre-wrap;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 0.5rem;
            color: #374151;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        details > summary {
            cursor: pointer;
            list-style: none;
            font-size: 1.125rem;
            font-weight: 600;
            color: #4b5563;
            padding: 0.5rem 0;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::before {
            content: '▶';
            margin-right: 0.5rem;
            font-size: 0.8em;
            display: inline-block;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">UNILAG Campus Load Profile Analysis</h1>
        
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px" aria-label="Tabs">
                <button id="daily-tab" class="tab-btn active" onclick="showTab('daily')">Daily Load Profile</button>
                <button id="yearly-tab" class="tab-btn" onclick="showTab('yearly')">Yearly Load Profile</button>
            </nav>
        </div>

        <div id="daily-chart-container" class="mt-4">
            <p class="text-center text-gray-500 mb-4 text-sm">Forecast for June 2, 2025. Drag to zoom, Shift+Drag to pan, Double-click to reset.</p>
            <div class="relative h-96">
                <canvas id="loadProfileChartDaily"></canvas>
            </div>
        </div>
        <div id="yearly-chart-container" class="hidden mt-4">
             <p class="text-center text-gray-500 mb-4 text-sm">Total monthly energy consumption for Jun 2025 - May 2026. Drag to zoom, Shift+Drag to pan, Double-click to reset.</p>
            <div class="relative h-96">
                <canvas id="loadProfileChartYearly"></canvas>
            </div>
        </div>
        <div id="loading" class="text-center text-gray-600 mt-4">Loading chart...</div>
        
        <div class="mt-8 border-t pt-6">
            <h2 class="text-xl font-semibold text-center text-gray-700 mb-4">Automated Analysis & Recommendations</h2>
            <details id="summary-details">
                <summary>Load Profile Summary</summary>
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mt-4">
                    <button id="generate-daily-summary-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 my-2">
                        Generate Daily Summary
                    </button>
                    <button id="generate-yearly-summary-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 my-2">
                        Generate Yearly Summary
                    </button>
                </div>
                <div id="summary-loader" class="loader hidden"></div>
                <div id="summary-output" class="gemini-output hidden"></div>
            </details>
            
            <details id="sizing-details" class="mt-4">
                <summary>Microgrid Sizing Suggestion</summary>
                <div class="flex justify-center">
                     <button id="generate-sizing-btn" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 my-2">
                        ✨ Get Sizing Suggestion
                    </button>
                </div>
                <div id="sizing-loader" class="loader hidden"></div>
                <div id="sizing-output" class="gemini-output hidden"></div>
            </details>
        </div>
    </div>

    <script>
        // --- Data Processing ---
        // This data is now pre-processed for accuracy and efficiency.
        
        // 1. Daily Data: The first 24 hours from the forecast.
        const dailyData = [
            { t: '2025-06-02T00:00:00', v: 1510.95 }, { t: '2025-06-02T01:00:00', v: 1342.10 },
            { t: '2025-06-02T02:00:00', v: 1215.51 }, { t: '2025-06-02T03:00:00', v: 1214.00 },
            { t: '2025-06-02T04:00:00', v: 1363.73 }, { t: '2025-06-02T05:00:00', v: 1762.77 },
            { t: '2025-06-02T06:00:00', v: 2759.00 }, { t: '2025-06-02T07:00:00', v: 3904.79 },
            { t: '2025-06-02T08:00:00', v: 5737.93 }, { t: '2025-06-02T09:00:00', v: 5957.24 },
            { t: '2025-06-02T10:00:00', v: 6033.11 }, { t: '2025-06-02T11:00:00', v: 6059.40 },
            { t: '2025-06-02T12:00:00', v: 6066.54 }, { t: '2025-06-02T13:00:00', v: 6006.14 },
            { t: '2025-06-02T14:00:00', v: 5871.88 }, { t: '2025-06-02T15:00:00', v: 5655.98 },
            { t: '2025-06-02T16:00:00', v: 5353.39 }, { t: '2025-06-02T17:00:00', v: 4964.44 },
            { t: '2025-06-02T18:00:00', v: 4495.05 }, { t: '2025-06-02T19:00:00', v: 3957.43 },
            { t: '2025-06-02T20:00:00', v: 3374.57 }, { t: '2025-06-02T21:00:00', v: 2777.93 },
            { t: '2025-06-02T22:00:00', v: 2214.49 }, { t: '2025-06-02T23:00:00', v: 1733.56 }
        ];

        // 2. Yearly Data: Pre-calculated monthly TOTALS (in MWh) from the full 8760-hour dataset.
        const yearlyData = {
            labels: ["Jun 2025", "Jul 2025", "Aug 2025", "Sep 2025", "Oct 2025", "Nov 2025", "Dec 2025", "Jan 2026", "Feb 2026", "Mar 2026", "Apr 2026", "May 2026"],
            totals: [2628.07, 2761.34, 2739.03, 2556.58, 2530.51, 2340.43, 2305.88, 2344.42, 2214.47, 2574.98, 2577.16, 2580.03]
        };

        const dailyLabels = dailyData.map(d => d.t);
        const dailyDataPoints = dailyData.map(d => d.v);

        function createChart(canvasId, type, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const isTimeScale = type === 'daily';
            
            const existingChart = Chart.getChart(canvasId);
            if (existingChart) {
                existingChart.destroy();
            }

            return new Chart(ctx, {
                type: 'line',
                data: { 
                    labels: labels, 
                    datasets: [{
                        label: type === 'daily' ? 'Power Demand (kW)' : 'Total Energy (MWh)',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: type === 'daily' ? 3 : 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: type === 'daily' ? 4 : 3,
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { 
                        y: { 
                            beginAtZero: true, 
                            title: { 
                                display: true, 
                                text: type === 'daily' ? 'Power Demand (kW)' : 'Total Monthly Energy (MWh)', 
                                font: { size: 14, weight: 'bold' } 
                            } 
                        }, 
                        x: { 
                            type: isTimeScale ? 'time' : 'category',
                            time: isTimeScale ? { unit: 'hour', tooltipFormat: 'HH:mm' } : undefined,
                            title: { display: true, text: type === 'yearly' ? 'Month' : 'Time of Day', font: { size: 14, weight: 'bold' } } 
                        } 
                    }, 
                    plugins: { 
                        legend: { display: false },
                        zoom: { pan: { enabled: true, mode: 'x', modifierKey: 'shift' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    onDoubleClick: (e, el, chart) => chart.resetZoom()
                }
            });
        }

        document.getElementById('loading').style.display = 'none';
        createChart('loadProfileChartDaily', 'daily', dailyLabels, dailyDataPoints);
        createChart('loadProfileChartYearly', 'yearly', yearlyData.labels, yearlyData.totals);

        function showTab(tabName) {
            document.getElementById('daily-chart-container').classList.toggle('hidden', tabName !== 'daily');
            document.getElementById('yearly-chart-container').classList.toggle('hidden', tabName !== 'yearly');
            document.getElementById('daily-tab').classList.toggle('active', tabName === 'daily');
            document.getElementById('yearly-tab').classList.toggle('active', tabName === 'yearly');
        }

        const summaryLoader = document.getElementById('summary-loader');
        const sizingLoader = document.getElementById('sizing-loader');
        const summaryOutput = document.getElementById('summary-output');
        const sizingOutput = document.getElementById('sizing-output');

        const hourlyDataString = dailyDataPoints.map((kw, i) => `${new Date(dailyLabels[i]).getHours()}:00 - ${kw.toFixed(2)} kW`).join('\n');
        const monthlyDataString = yearlyData.totals.map((mwh, i) => `${yearlyData.labels[i]}: ${mwh.toFixed(2)} MWh`).join('\n');

        async function callGemini(prompt, loader, outputDiv) {
            loader.style.display = 'block';
            outputDiv.classList.add('hidden');
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) {
                    outputDiv.innerText = result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("No content received from API.");
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                outputDiv.innerText = `An error occurred. Please check the console for details. \n${error.message}`;
            } finally {
                loader.style.display = 'none';
                outputDiv.classList.remove('hidden');
            }
        }

        document.getElementById('generate-daily-summary-btn').addEventListener('click', () => {
            const prompt = `Analyze the following 24-hour electricity load profile data for a university campus. Provide a concise summary including: 1. Peak Load (kW) and the time it occurred. 2. Minimum Load (kW) and the time it occurred. 3. Total Daily Energy Consumption (in MWh). 4. Average Load (kW). 5. Load Factor (Average Load / Peak Load). Present the output as a clean, easy-to-read report.\n\nHourly Data:\n${hourlyDataString}`;
            callGemini(prompt, summaryLoader, summaryOutput);
        });

        document.getElementById('generate-yearly-summary-btn').addEventListener('click', () => {
            const prompt = `Analyze the following yearly electricity load profile data, which shows the total energy consumption (MWh) for each month. Provide a concise summary of the seasonal trends. Identify: 1. The month with the highest total consumption. 2. The month with the lowest total consumption. 3. The overall pattern of consumption throughout the year (e.g., when does consumption rise and fall?).\n\nMonthly Total Consumption Data:\n${monthlyDataString}`;
            callGemini(prompt, summaryLoader, summaryOutput);
        });

        document.getElementById('generate-sizing-btn').addEventListener('click', () => {
            const prompt = `Act as a senior microgrid design engineer. Based on the following 24-hour electricity load profile for a university campus, provide a preliminary, high-level recommendation for a solar PV and Battery Energy Storage System (BESS). Your recommendation should include: 1. Recommended Solar PV System Size (in MWp): Justify your choice based on covering the daytime peak load. 2. Recommended BESS Size (in MW for power and MWh for energy): Justify your choice based on strategies like peak shaving and load shifting to cover the evening demand after sunset. 3. Briefly explain the operational strategy. Present this as a professional recommendation.\n\nHourly Data:\n${hourlyDataString}`;
            callGemini(prompt, sizingLoader, sizingOutput);
        });
    </script>
</body>
</html>
